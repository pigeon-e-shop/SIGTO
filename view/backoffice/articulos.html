<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Gestion de articulos</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400&display=swap" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
        <link rel="stylesheet" href="/assets/css/backoffice.scss" />
    </head>
    <body class="container-flex">
        <header class="container-flex w-100">
            <div class="row container">
                <div class="col-2 col-md-2">
                    <button class="btn fs-1" data-bs-toggle="offcanvas" role="button" data-bs-target="#rectangle" aria-controls="rectangle" tabindex="-1"><i class="bi bi-list"></i></button>
                </div>
                <p class="col-10 col-md-10 align-self-center display-3">Pigeon e-Shop</p>
            </div>
            <div class="rectangle offcanvas offcanvas-start" id="rectangle">
                <div class="container d-flex flex-column">
                    <div class="d-flex align-self-end">
                        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                    </div>
                    <div class="row align-items-start list-container flex-grow-1">
                        <a href="/view/backoffice/articulos.html" class="list-item btn">
                            <span>Gestionar art√≠culos</span>
                            <span>üëÅÔ∏è</span>
                        </a>
                        <a href="/view/backoffice/ventas.html" class="btn list-item">
                            <span>Ventas</span>
                            <span>üí∞</span>
                        </a>
                        <a href="/view/backoffice/pedidos.html" class="btn list-item">
                            <span>Pedidos</span>
                            <span>üì¶</span>
                        </a>
                        <a href="/view/backoffice/vendedores.html" class="btn list-item">
                            <span>Vendedores</span>
                            <span>üë§</span>
                        </a>
                        <a href="/view/backoffice/" class="btn list-item">
                            <span>Mi empresa</span>
                            <span>üè¢</span>
                        </a>
                    </div>
                    <div class="row fixed-bottom position-absolute align-items-end">
                        <div class="cerrar-ses">
                            <button class="btn" id="cerrarSesion">
                                <span>Cerrar sesi√≥n</span>
                                <span>
                                    <i class="bi bi-box-arrow-right"></i>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <main class="container-flex m-3">
            <table class="table table-responsive table-striped">
                <thead>
                    <tr>
                        <td>ID articulo</td>
                        <td>Nombre</td>
                        <td>Precio</td>
                        <td>Descuento</td>
                        <td>Stock</td>
                        <td>Imagen</td>
                        <td>Visibilidad</td>
                        <td>Acciones</td>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </main>
        <script src="/assets/js/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>

            $(document).ready(function () {
                $.ajax({
                    type: "POST",
                    url: "/controller/backoffice.controller.php",
                    data: { mode: "getArticulos" },
                    success: function (response) {
                        response.forEach((element) => {
                            const checked = element.VISIBLE == 1 ? "checked" : "";
                            const newRow = `
                    <tr class="table-row" data-vs="${element.id}">
                        <td>${element.id}</td>
                        <td>${element.nombre}</td>
                        <td>${element.precio}</td>
                        <td>${element.descuento}%</td>
                        <td>${element.stock}</td>
                        <td>
                        <a href="${element.rutaImagen}" 
                           data-pswp-width="100" 
                           data-pswp-height="100" 
                           class="my-image">
                            <img src="${element.rutaImagen}" height="50" alt="Descripci√≥n de la imagen" />
                        </a>
                     
                        </td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input visibilidad" type="checkbox" value="${element.VISIBLE}" id="visibilidad${element.id}" ${checked}/>
                                <label class="form-check-label" for="visibilidad${element.id}"></label>
                            </div>
                        </td>
                        <td>
                            <ul class="list-group">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <button class="btn btn-primary edit">Editar</button>
                                    <button class="btn btn-success detalles">Ver detalles</button>
                                    <button class="btn btn-secondary visitPage">Ir a p√°gina de art√≠culo</button>
                                </li>
                            </ul>
                        </td>
                    </tr>
                `;
                            $("tbody").append(newRow);
                        });
                        $(".visibilidad").on("change", function () {
                            const idArticulo = $(this).closest("tr").data("vs");
                            const visibility = $(this).is(":checked") ? 1 : 0;

                            $.ajax({
                                type: "POST",
                                url: "/controller/backoffice.controller.php",
                                data: {
                                    mode: "cambiarVisibilidad",
                                    visibilidad: visibility,
                                    idArticulo: idArticulo,
                                },
                                success: function (response) {
                                    console.log(response);
                                },
                            });
                        });
                    },
                });

                $(document).on("click", ".visitPage", function (e) {
                    e.preventDefault();
                    const idArticulo = $(this).closest("tr").data("vs");
                    window.location.href = `/view/tienda/detalle_producto.html?id=${idArticulo}&modo=exclusivo2`;
                });

                $(document).on("click",'.detalles', function (e) {
                    e.preventDefault();
                    const idArticulo = $(this).closest("tr").data("vs");
                    window.location.href = `/view/backoffice/articulos.detalles.html?id=${idArticulo}`;
                });

            });
        </script>
    </body>
</html>
