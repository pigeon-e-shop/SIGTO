<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
        <title>Document</title>
    </head>
    <body class="">
        <header>Pigeon e-Shop</header>
        <main class="container p-5">
            <form id="form" class="col" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="nombre" class="form-label">Nombre</label>
                    <input type="text" class="form-control" name="nombre" id="nombre" aria-describedby="helpId" placeholder="Nombre" />
                    <small id="helpId" class="form-text text-muted">Nombre del articulo.</small>
                </div>
                <div class="mb-3">
                    <label for="descripcion" class="form-label">Descripcion</label>
                    <textarea class="form-control" name="descripcion" id="descripcion" rows="1" aria-describedby="helpId"></textarea>
                    <small id="helpId" class="form-text text-muted">Descripcion del articulo.</small>
                </div>
                <div class="mb-3">
                    <label for="precio" class="form-label">Precio</label>
                    <input type="number" class="form-control" name="precio" id="precio" aria-describedby="helpId" step="0.01" placeholder="0.00" />
                    <small id="helpId" class="form-text text-muted">Precio del articulo.</small>
                </div>
                <div class="mb-3">
                    <label for="categorias" class="form-label">Categorias</label>
                    <select class="form-select form-select-lg" name="categorias" id="categorias"></select>
                </div>
                <div class="mb-3">
                    <label for="descuento" class="form-label">Descuento</label>
                    <input type="number" class="form-control" name="descuento" id="descuento" aria-describedby="helpId" placeholder="0" />
                    <small id="helpId" class="form-text text-muted">Descuento del articulo.</small>
                </div>
                <div class="mb-3">
                    <label for="stock" class="form-label">Stock</label>
                    <input type="number" class="form-control" name="stock" id="stock" aria-describedby="helpId" placeholder="0" />
                    <small id="helpId" class="form-text text-muted">Stock del articulo.</small>
                </div>
                <div class="mb-3">
                    <label for="imagen" class="form-label">Imagen</label>
                    <input type="file" class="form-control" name="imagen" id="imagen" placeholder="imagen.png" aria-describedby="fileHelpId" />
                    <div id="fileHelpId" class="form-text">Usa un archivo .png para que conserve mejor la calidad.</div>
                </div>
                <button type="submit" class="btn btn-info">Actualizar</button>
            </form>
            <div id="previewContainer" class="col"></div>
        </main>
        <script src="/assets/js/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
        <script>
            $(document).ready(function () {
                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get("id");

                let categorias = ["Teléfonos móviles", "Computadoras y Laptops", "Televisores y Audio", "Accesorios tecnológicos", "Ropa de Hombre", "Ropa de Mujer", "Zapatos y Accesorios", "Ropa para Niños", "Muebles", "Decoración", "Herramientas y Mejoras para el Hogar", "Jardinería", "Productos para el Cuidado de la Piel", "Maquillaje", "Productos para el Cuidado del Cabello", "Suplementos y Vitaminas", "Equipamiento Deportivo", "Ropa Deportiva", "Bicicletas y Patinetes", "Camping y Senderismo", "Juguetes para Niños", "Juegos de Mesa", "Videojuegos y Consolas", "Puzzles y Rompecabezas", "Accesorios para Automóviles", "Accesorios para Motocicletas", "Herramientas y Equipos", "Neumáticos y Llantas", "Comida Gourmet", "Bebidas Alcohólicas", "Alimentos Orgánicos", "Snacks y Dulces", "Ropa de Bebé", "Juguetes para Bebés", "Productos para la Alimentación del Bebé", "Mobiliario Infantil", "Libros Físicos y E-Books", "Música y CDs", "Instrumentos Musicales", "Audiolibros y Podcasts"];
                for (let index = 0; index < categorias.length; index++) {
                    const element = categorias[index];
                    $("#categorias").append(`<option>${element}</option>`);
                }

                $("#imagen").on("change", function () {
                    const file = this.files[0];
                    const maxSize = 2 * 1024 * 1024; // 2 MB en bytes

                    if (file) {
                        if (file.size > maxSize) {
                            alert("El archivo es demasiado grande. El tamaño máximo permitido es de 2 MB.");
                            $(this).val(""); // Limpiar el input
                            $("#previewContainer").empty(); // Limpiar la vista previa
                        } else {
                            const reader = new FileReader();
                            reader.onload = function (event) {
                                $("#previewContainer").html(`
                                <h4>Vista Previa:</h4>
                                <img src="${event.target.result}" height="150" alt="Vista previa de la imagen">
                            `);
                            };
                            reader.readAsDataURL(file);
                        }
                    } else {
                        $("#previewContainer").empty(); // Limpiar si no hay archivo
                    }
                });
                $("#form").on("submit", function (e) {
                    e.preventDefault();
                    let formData = new FormData(this);
                    formData.append("mode", "updateArticulo");
                    formData.append("id",productId);
                    $.ajax({
                        type: "POST",
                        url: "/controller/backoffice.controller.php",
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function (response) {
                            window.location.href = "/view/backoffice/articulos.html"
                        },
                        error: function (xhr, status, error) {
                            $("#response").html("Error: " + error);
                        },
                    });
                });
                $.ajax({
                    type: "POST",
                    url: "/controller/backoffice.controller.php",
                    data: {
                        mode: "getArticulo",
                        id: productId,
                    },
                    dataType: "JSON",
                    success: function (response) {
                        $("#nombre").val(response.nombre);
                        $("#descripcion").val(response.descripcion);
                        $("#precio").val(response.precio);
                        $("#categorias").val(response.categoria);
                        $("#descuento").val(response.descuento);
                        $("#stock").val(response.stock);
                        $("#previewContainer").html(`
                                <h4>Vista Previa:</h4>
                                <img src="${response.rutaImagen}" height="150" alt="Vista previa de la imagen">
                            `);
                    },
                });
            });
        </script>
    </body>
</html>
